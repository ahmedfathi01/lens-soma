# دليل تكامل خدمة الدفع PayTabs مع متجر استوديو ماسا

## نظرة عامة

تم تكامل خدمة الدفع PayTabs مع نظام المتجر الخاص باستوديو ماسا لتسهيل عملية الدفع الإلكتروني للعملاء. يتيح هذا التكامل للعملاء اختيار طريقة الدفع المناسبة لهم عند الشراء من المتجر.

## المكونات الرئيسية

### 1. StorePaytabsService

خدمة تتعامل مباشرة مع واجهة برمجة تطبيقات PayTabs، وتتضمن الوظائف التالية:
- إنشاء طلبات دفع جديدة
- الاستعلام عن حالة المعاملات
- معالجة استجابات الدفع
- التحقق من حالة الدفع

### 2. StorePaymentService

خدمة تعمل كوسيط بين متحكم الدفع (CheckoutController) وخدمة PayTabs، وتوفر وظائف:
- بدء عملية الدفع
- معالجة استجابات الدفع
- البحث عن الطلبات الموجودة
- تحديث حالة الطلب بناءً على نتيجة الدفع
- إنشاء طلب جديد بعد نجاح الدفع

### 3. CheckoutController

متحكم يدير عملية الدفع ويتضمن:
- عرض نموذج الدفع للعميل
- معالجة البيانات المدخلة والتحقق منها
- إنشاء الطلب وبدء عملية الدفع
- التعامل مع استجابات بوابة الدفع
- عرض نتائج عملية الدفع للمستخدم

## تدفق عملية الدفع

### 1. اختيار طريقة الدفع

عند وصول العميل لصفحة الدفع، يمكنه الاختيار بين:
- الدفع عند الاستلام: يتم إنشاء الطلب مباشرة بحالة "معلق"
- الدفع الإلكتروني: يتم توجيه العميل لبوابة الدفع PayTabs

### 2. الدفع الإلكتروني

في حالة اختيار الدفع الإلكتروني، يتم اتباع الخطوات التالية:
1. التحقق من بيانات الطلب
2. تخزين بيانات الطلب في الجلسة
3. إنشاء طلب دفع جديد عبر PaytabsService
4. توجيه العميل إلى صفحة الدفع الآمنة
5. إكمال العميل لعملية الدفع
6. إعادة توجيه العميل إلى المتجر

### 3. معالجة استجابة الدفع

بعد إتمام عملية الدفع، يتم معالجة الاستجابة من خلال:
1. استخراج بيانات الدفع من الطلب
2. التحقق من حالة الدفع عبر استعلام PayTabs
3. البحث عن الطلب الموجود أو إنشاء طلب جديد
4. تحديث حالة الطلب بناءً على نتيجة الدفع
5. إعادة توجيه العميل إلى صفحة الطلب أو صفحة الخطأ

## الإعداد والتكوين

### ملفات التكوين

يتم تكوين خدمة PayTabs في ملف `config/services.php`:

```php
'paytabs' => [
    'profile_id' => env('PAYTABS_PROFILE_ID'),
    'server_key' => env('PAYTABS_SERVER_KEY'),
    'currency' => env('PAYTABS_CURRENCY', 'SAR'),
    'is_sandbox' => env('PAYTABS_SANDBOX', true),
],
```

### متغيرات البيئة المطلوبة

يجب إضافة المتغيرات التالية في ملف `.env`:

```
PAYTABS_PROFILE_ID=your_profile_id
PAYTABS_SERVER_KEY=your_server_key
PAYTABS_CURRENCY=SAR
PAYTABS_SANDBOX=true
```

### المسارات

تم إضافة المسارات التالية للتعامل مع عمليات الدفع:

```php
Route::name('checkout.payment.')->group(function () {
    Route::post('/checkout/payment/callback', [CheckoutController::class, 'paymentCallback'])->name('callback');
    Route::get('/checkout/payment/return', [CheckoutController::class, 'paymentReturn'])->name('return');
});
```

## واجهة المستخدم

تم تحديث صفحة الدفع لتشمل اختيار طريقة الدفع:
1. الدفع عند الاستلام (الافتراضي)
2. الدفع الإلكتروني (عبر PayTabs)

### تغييرات واجهة المستخدم

- إضافة خيارات طريقة الدفع
- تحديث نص زر التأكيد بناءً على طريقة الدفع المختارة
- إضافة أيقونات لبطاقات الدفع المدعومة

## حالات الدفع المختلفة

### نجاح الدفع

عند نجاح عملية الدفع:
- يتم تحديث حالة الطلب إلى "قيد المعالجة"
- يتم تحديث حالة الدفع إلى "مدفوع"
- يتم إرسال إشعار تأكيد الطلب للعميل

### فشل الدفع

عند فشل عملية الدفع:
- يتم توجيه العميل إلى صفحة الدفع مع رسالة خطأ
- يمكن للعميل إعادة المحاولة مرة أخرى

### الدفع المعلق

في حالة الدفع المعلق:
- يتم إنشاء الطلب بحالة "معلق"
- يتم تحديث حالة الدفع إلى "معلق"
- يمكن تحديث حالة الطلب لاحقًا عند تأكيد الدفع

## الأمان

### إجراءات الأمان المتبعة

1. جميع اتصالات الدفع تتم عبر HTTPS المشفر
2. لا يتم تخزين بيانات بطاقات الائتمان على خوادمنا
3. يتم التحقق من صحة جميع استجابات الدفع باستخدام مفتاح الخادم
4. التعامل الآمن مع بيانات العملاء وفقًا لمعايير أمان البيانات

### التعامل مع المعاملات المكررة

- النظام يتحقق من وجود طلب سابق بنفس معرف الدفع قبل إنشاء طلب جديد
- يتم توجيه المستخدم إلى الطلب الموجود في حالة تكرار المعاملة

## تصحيح الأخطاء

### سجلات الأخطاء

النظام يقوم بتسجيل:
- طلبات الدفع وتفاصيلها
- استجابات بوابة الدفع
- أخطاء الاتصال أو المعالجة
- معلومات التصحيح والتتبع

### المشاكل الشائعة وحلولها

1. **خطأ "فشل الاتصال ببوابة الدفع"**
   - تحقق من إعدادات PayTabs في ملف `.env`
   - تأكد من توفر اتصال إنترنت مستقر
   - تحقق من صحة مفاتيح API

2. **خطأ "لم يتم العثور على بيانات الطلب"**
   - قد تكون انتهت جلسة المستخدم
   - يجب على المستخدم إعادة ملء نموذج الدفع

3. **الطلب بحالة "معلق" لفترة طويلة**
   - تحقق من لوحة تحكم PayTabs
   - يمكن إضافة وظيفة مجدولة للتحقق الدوري من حالة الطلبات المعلقة

## اختبار النظام

يمكن اختبار نظام الدفع باستخدام الحسابات التجريبية لـ PayTabs:

### بيانات بطاقة اختبار Visa/Mastercard:
- رقم البطاقة: 4000000000000002
- تاريخ الانتهاء: أي تاريخ مستقبلي
- CVV: أي 3 أرقام
- اسم صاحب البطاقة: أي اسم

### بيانات بطاقة اختبار مدى:
- رقم البطاقة: 4111111111111111
- تاريخ الانتهاء: أي تاريخ مستقبلي
- CVV: أي 3 أرقام
- اسم صاحب البطاقة: أي اسم

## الخاتمة

تكامل PayTabs مع نظام المتجر يوفر تجربة دفع آمنة وسلسة للعملاء. يدعم النظام طرق الدفع المختلفة ويتعامل مع حالات الدفع المتنوعة بشكل فعال. 
