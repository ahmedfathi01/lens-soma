# توثيق نظام الحجز - ستوديو ماسا للتصوير

## نظرة عامة
نظام حجز ستوديو ماسا للتصوير هو تطبيق ويب يتيح للعملاء حجز جلسات التصوير عبر الإنترنت. يتكامل النظام مع بوابة الدفع PayTabs لمعالجة المدفوعات عبر الإنترنت ويوفر تجربة حجز سلسة.

## هيكل النظام

### المكونات الأساسية

1. **متحكم الحجز (BookingController)** - يتعامل مع إنشاء الحجوزات، ومعالجة الدفع، وإدارة الحجوزات
2. **تكامل PayTabs** - يعالج المدفوعات الآمنة عبر الإنترنت
3. **نموذج الحجز الأمامي** - واجهة سهلة الاستخدام للعملاء لاختيار الخدمات والباقات

## توثيق المكونات بالتفصيل

### 1. متحكم الحجز (`BookingController.php`)

متحكم الحجز هو المتحكم الرئيسي الذي يتعامل مع تدفق الحجز. يحتوي على عدة طرق رئيسية:

#### `index()`
- **الغرض**: عرض صفحة نموذج الحجز
- **الوظائف**:
  - تحميل الخدمات النشطة والباقات والإضافات
  - استرجاع صور المعرض للعرض المتحرك
  - إعادة ملء النموذج بالبيانات السابقة إذا كانت متاحة
  - إرجاع عرض نموذج الحجز

#### `store()`
- **الغرض**: إنشاء حجز جديد وبدء الدفع
- **الوظائف**:
  - التحقق من صحة مدخلات النموذج (الخدمات، الباقات، التواريخ، إلخ)
  - حساب المبلغ الإجمالي بما في ذلك الإضافات
  - إنشاء معرف دفع فريد
  - تخزين بيانات الحجز في الجلسة
  - تجهيز طلب الدفع إلى PayTabs
  - التعامل مع اتصال بوابة الدفع مع آلية إعادة المحاولة
  - إعادة التوجيه إلى صفحة دفع PayTabs أو إرجاع خطأ

#### `paymentCallback()` و `paymentReturn()`
- **الغرض**: معالجة ردود الدفع من PayTabs
- **الوظائف**:
  - استخراج بيانات الدفع من الطلب
  - التحقق من حالة الدفع مع PayTabs
  - التحقق من الحجوزات الموجودة
  - إنشاء حجز جديد إذا نجح الدفع
  - تحديث حالة الحجز بناءً على نتيجة الدفع
  - إعادة توجيه المستخدم إلى الصفحة المناسبة

#### `success()`
- **الغرض**: عرض صفحة نجاح الحجز
- **الوظائف**:
  - التحقق من ملكية الحجز
  - عرض تفاصيل الحجز والتأكيد

#### `myBookings()`
- **الغرض**: عرض قائمة بجميع حجوزات المستخدم الحالي
- **الوظائف**:
  - جلب الحجوزات مع النماذج المرتبطة
  - ترقيم النتائج
  - إرجاع العرض مع بيانات الحجوزات

#### `show()`
- **الغرض**: عرض تفاصيل حجز محدد
- **الوظائف**:
  - التحقق من ملكية الحجز
  - تحميل الحجز مع البيانات المرتبطة
  - إرجاع عرض مفصل

#### `saveFormData()`
- **الغرض**: حفظ بيانات النموذج في الجلسة للضيوف
- **الوظائف**:
  - حفظ بيانات النموذج المقدمة في الجلسة
  - إعادة التوجيه إلى مسار التسجيل أو أي مسار مخصص

### 2. معالجة دفع PayTabs

النظام يتكامل مع بوابة دفع PayTabs لمعالجة المدفوعات الآمنة عبر الإنترنت.

#### `extractPaymentData()`
- **الغرض**: استخراج بيانات الدفع من الطلب
- **الوظائف**:
  - استخراج معلومات الدفع الأساسية مثل الحالة والمعرّف ورقم المعاملة

#### `queryPayTabsStatus()`
- **الغرض**: الاستعلام عن حالة الدفع من PayTabs
- **الوظائف**:
  - إرسال طلب إلى واجهة برمجة تطبيقات PayTabs للتحقق من حالة المعاملة
  - تحديث معلومات الدفع بناءً على الاستجابة
  - تحديد ما إذا كان الدفع ناجحًا أو معلقًا

#### `findExistingBooking()`
- **الغرض**: البحث عن حجز موجود مرتبط بالدفع
- **الوظائف**:
  - البحث عن الحجوزات باستخدام معرّف المعاملة أو معرّف الدفع

#### `handleExistingBooking()`
- **الغرض**: التعامل مع الحجز الموجود بعد استجابة الدفع
- **الوظائف**:
  - تحديث حالة الحجز إذا كان الدفع ناجحًا
  - إعادة التوجيه إلى صفحة النجاح مع رسالة مناسبة

#### `handleFailedPayment()`
- **الغرض**: التعامل مع فشل الدفع
- **الوظائف**:
  - إزالة بيانات الحجز المعلقة من الجلسة
  - إعادة التوجيه إلى صفحة إنشاء الحجز مع رسالة خطأ

#### `createNewBooking()`
- **الغرض**: إنشاء حجز جديد بعد الدفع الناجح
- **الوظائف**:
  - تنظيف بيانات الحجز قبل الإنشاء
  - إنشاء سجل حجز جديد
  - إرفاق الإضافات المحددة بالحجز
  - إعادة التوجيه إلى صفحة النجاح

### 3. نموذج الحجز الأمامي

يوفر النظام واجهة مستخدم سهلة الاستخدام للعملاء لحجز جلسات التصوير.

#### المكونات الرئيسية:
- **عرض الصور المتحرك**: يعرض صور المعرض في أعلى الصفحة
- **اختيار الخدمة**: يتيح للعملاء اختيار نوع جلسة التصوير
- **اختيار الباقة**: يعرض الباقات المتاحة مع التفاصيل والأسعار
- **اختيار الإضافات**: يتيح للعملاء اختيار إضافات اختيارية لتعزيز تجربتهم
- **تحديد التاريخ والوقت**: واجهة لاختيار تاريخ ووقت الجلسة
- **معلومات الطفل**: حقول لإدخال اسم المولود وتاريخ الميلاد والجنس
- **الموافقات**: خيارات للموافقة على سياسة عرض الصور وشروط الخدمة
- **متابعة الدفع**: زر يوجه العميل إلى صفحة الدفع

## مسارات النظام

تم تعريف المسارات التالية للتعامل مع وظائف الحجز:

- `GET /client/book` - عرض صفحة الحجز الرئيسية
- `POST /client/book/save-form` - حفظ بيانات النموذج للمستخدمين غير المسجلين
- `POST /client/bookings/store` - إنشاء حجز جديد وبدء عملية الدفع
- `GET /client/bookings/success/{booking:uuid}` - عرض صفحة نجاح الحجز
- `GET /client/bookings/my` - عرض قائمة حجوزات المستخدم
- `GET /client/bookings/{booking:uuid}` - عرض تفاصيل حجز محدد
- `POST /client/bookings/available-slots` - الحصول على المواعيد المتاحة ليوم معين
- `POST /client/bookings/payment/callback` - نقطة نهاية استدعاء الدفع
- `GET /client/bookings/payment/return` - نقطة نهاية إرجاع الدفع

## آلية الدفع عبر PayTabs

يستخدم النظام بوابة الدفع PayTabs لمعالجة المدفوعات عبر الإنترنت. تتضمن العملية الخطوات التالية:

1. **إعداد بيانات الدفع**: إنشاء مصفوفة تحتوي على تفاصيل المعاملة والعميل
2. **إرسال طلب الدفع**: إرسال طلب POST إلى واجهة برمجة تطبيقات PayTabs
3. **إعادة التوجيه**: توجيه العميل إلى صفحة دفع PayTabs
4. **معالجة الاستجابة**: استقبال ومعالجة استجابة الدفع عبر نقاط النهاية المحددة
5. **التحقق من الحالة**: الاستعلام عن حالة المعاملة للتأكد من نجاح الدفع
6. **تحديث الحجز**: تأكيد الحجز أو وضعه في حالة معلقة/فاشلة بناءً على نتيجة الدفع

## آلية التعامل مع الأخطاء

يتضمن النظام آليات متعددة للتعامل مع الأخطاء والحالات الاستثنائية:

1. **آلية إعادة المحاولة**: إعادة المحاولة تلقائيًا عند فشل الاتصال ببوابة الدفع
2. **تخزين بيانات النموذج**: حفظ بيانات النموذج في حالة فشل الدفع للسماح بإعادة المحاولة بسهولة
3. **رسائل خطأ واضحة**: عرض رسائل خطأ واضحة للمستخدمين عند حدوث مشكلات
4. **تسجيل الأخطاء**: تسجيل معلومات الخطأ التفصيلية لتسهيل تصحيح الأخطاء

## الوظائف المستقبلية المحتملة

1. **إدارة الإلغاء وإعادة الجدولة**: السماح للعملاء بإلغاء الحجوزات أو إعادة جدولتها
2. **دفعات مقدمة**: تنفيذ خيار لدفع جزء من المبلغ كدفعة مقدمة
3. **كوبونات الخصم**: دعم تطبيق كوبونات الخصم على الحجوزات
4. **الإشعارات المتقدمة**: إرسال تذكيرات وإشعارات متقدمة للعملاء
5. **التكامل مع التقويم**: السماح للعملاء بإضافة المواعيد إلى تقويمهم الإلكتروني 
