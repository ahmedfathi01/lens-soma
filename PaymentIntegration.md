# توثيق تكامل PayTabs مع نظام حجز استوديو التصوير

## مقدمة
يوفر هذا المستند توثيقًا لتكامل نظام الدفع PayTabs مع نظام حجز استوديو التصوير. يتيح هذا التكامل للعملاء دفع تكاليف حجوزات التصوير إلكترونيًا.

## المكونات الرئيسية

### 1. خدمة PayTabs (PaytabsService)
توفر هذه الخدمة واجهة برمجية للتعامل مع بوابة دفع PayTabs وتتضمن:
- إنشاء طلبات دفع جديدة
- الاستعلام عن حالة المعاملات
- معالجة استجابات الدفع
- التحقق من حالة الدفع

### 2. خدمة الدفع (PaymentService)
تعمل هذه الخدمة كوسيط بين المتحكمات وخدمة PayTabs، وتوفر وظائف:
- بدء عملية الدفع
- معالجة استجابات الدفع
- البحث عن الحجوزات الموجودة
- تحديث حالة الحجز بناءً على نتيجة الدفع
- إنشاء حجز جديد بعد نجاح الدفع

### 3. متحكم الحجز (BookingController)
تم تحديث المتحكم ليدعم:
- بدء عملية الدفع عند إنشاء حجز جديد
- معالجة استجابات الدفع
- معالجة إعادة توجيه المستخدم من بوابة الدفع

## كيفية الإعداد

### متطلبات الإعداد
1. حساب PayTabs تجاري أو حساب اختبار
2. معرف الملف الشخصي (Profile ID) من PayTabs
3. مفتاح الخادم (Server Key) من PayTabs
4. مفتاح العميل (Client Key) من PayTabs

### خطوات الإعداد
1. أضف متغيرات البيئة إلى ملف `.env`:
```
PAYTABS_PROFILE_ID=your_profile_id
PAYTABS_SERVER_KEY=your_server_key
PAYTABS_CLIENT_KEY=your_client_key
PAYTABS_IS_SANDBOX=true  # استخدم false للبيئة الإنتاجية
```

2. تأكد من تسجيل الخدمات في حاوية Laravel للتبعيات

## تدفق عملية الدفع

### 1. إنشاء الحجز وبدء الدفع
```
إنشاء نموذج الحجز -> التحقق من صحة البيانات -> حساب المبلغ -> بدء عملية الدفع -> إعادة التوجيه لصفحة الدفع
```

عند إرسال نموذج الحجز، يقوم النظام بما يلي:
1. التحقق من صحة البيانات المدخلة
2. التحقق من توفر الموعد المطلوب
3. حساب المبلغ الإجمالي (سعر الباقة + الإضافات)
4. تحضير بيانات الدفع وإنشاء طلب دفع عبر PayTabs
5. إعادة توجيه المستخدم إلى صفحة الدفع الآمنة

### 2. معالجة استجابة الدفع
بعد إتمام عملية الدفع، يتم إعادة توجيه المستخدم إلى موقعنا عبر أحد المسارين:
- مسار `payment.callback`: يستقبل طلبات HTTP POST من خادم PayTabs
- مسار `payment.return`: يستقبل إعادة توجيه العميل بعد الدفع

يقوم النظام بمعالجة الاستجابة من خلال:
1. استخراج بيانات الدفع من الطلب
2. التحقق من حالة الدفع عبر استعلام PayTabs
3. البحث عن الحجز الموجود أو إنشاء حجز جديد
4. تحديث حالة الحجز بناءً على نتيجة الدفع
5. إعادة توجيه المستخدم إلى صفحة نجاح الحجز أو صفحة الخطأ

## حالات الدفع المختلفة

### حالات نجاح الدفع
عند نجاح الدفع (حالة `A` أو `CAPTURED` أو غيرها من حالات النجاح):
- يتم إنشاء الحجز أو تحديث حالته إلى `confirmed`
- يتم تحديث بيانات الدفع وحفظ معرف المعاملة
- يتم عرض رسالة نجاح للمستخدم

### حالات الدفع المعلقة
في حالة الدفع المعلق (حالة `PENDING` أو `H` أو `P`):
- يتم إنشاء الحجز بحالة `pending`
- يتم تخزين معلومات الدفع للتحقق لاحقًا
- يتم إخبار المستخدم أن الدفع قيد المعالجة

### حالات فشل الدفع
في حالة فشل الدفع:
- يتم إعادة توجيه المستخدم إلى صفحة الحجز مع رسالة خطأ
- يتم الاحتفاظ ببيانات النموذج لتسهيل إعادة المحاولة
- لا يتم إنشاء حجز في قاعدة البيانات

## تصحيح الأخطاء

### سجلات الخطأ
يقوم النظام بتسجيل جميع المعلومات المتعلقة بالدفع مثل:
- طلبات الدفع
- استجابات الدفع
- أخطاء الاتصال
- فشل إنشاء الحجوزات

يمكن الوصول إلى هذه السجلات في ملفات سجل Laravel العادية.

### مشاكل شائعة وحلولها
1. **خطأ "فشل الاتصال ببوابة الدفع"**
   - تحقق من إعدادات PayTabs في ملف `.env`
   - تأكد من توفر اتصال إنترنت مستقر
   - تحقق من عدم وجود قيود جدار حماية تمنع الاتصال

2. **خطأ "خطأ في الدفع - لم يتم العثور على بيانات الحجز"**
   - قد تكون انتهت جلسة المستخدم، يجب إعادة ملء نموذج الحجز
   - قد يكون المستخدم قد استخدم زر الرجوع في المتصفح بعد الدفع

3. **الحجز بحالة "معلق" لفترة طويلة**
   - تحقق من لوحة تحكم PayTabs للتأكد من حالة المعاملة
   - يمكن إنشاء وظيفة مجدولة للتحقق دوريًا من المعاملات المعلقة

## أمان الدفع

### الإجراءات الأمنية
1. جميع اتصالات الدفع تتم عبر HTTPS المشفر
2. لا يتم تخزين بيانات بطاقات الائتمان على خوادمنا
3. يتم التحقق من صحة جميع استجابات الدفع باستخدام مفتاح الخادم

### التعامل مع المعاملات المكررة
- النظام يتحقق من وجود حجز سابق بنفس معرف الدفع قبل إنشاء حجز جديد
- يتم إعادة توجيه المستخدم إلى الحجز الموجود في حالة تكرار المعاملة

## الخاتمة
يوفر تكامل PayTabs طريقة آمنة وفعالة لتحصيل المدفوعات الإلكترونية لحجوزات التصوير. يرجى الاطلاع على الوثائق الرسمية لـ PayTabs للحصول على معلومات أكثر تفصيلاً حول واجهة برمجة التطبيقات والميزات المتقدمة. 
